name: Build PandoraTrader

on:
  push:
    branches: [main, ndev, develop]
  pull_request:
    branches: [main, ndev, develop]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu ç‰ˆæœ¬
          - os: ubuntu-24.04
            name: 'Ubuntu 24.04'
            build_type: Debug
          - os: ubuntu-24.04
            name: 'Ubuntu 24.04'
            build_type: Release
          - os: ubuntu-22.04
            name: 'Ubuntu 22.04'
            build_type: Debug
          - os: ubuntu-22.04
            name: 'Ubuntu 22.04'
            build_type: Release
          # macOS ç‰ˆæœ¬
          - os: macos-15
            name: 'macOS 15'
            build_type: Debug
          - os: macos-15
            name: 'macOS 15'
            build_type: Release
          - os: macos-14
            name: 'macOS 14'
            build_type: Debug
          - os: macos-14
            name: 'macOS 14'
            build_type: Release

    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.name }} (${{ matrix.build_type }})

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "=== Installing dependencies on Linux ==="
            sudo apt-get update
            sudo apt-get install -y cmake build-essential libomp-dev pkg-config
            
            echo ""
            echo "=== Verifying OpenMP installation on Linux ==="
            
            # æ£€æŸ¥ OpenMP å¼€å‘åŒ…
            if dpkg -l | grep -q libomp-dev; then
              echo "âœ… libomp-dev package installed"
              dpkg -l | grep libomp
            else
              echo "âŒ libomp-dev package not found"
              exit 1
            fi
            
            # æ£€æŸ¥ OpenMP å¤´æ–‡ä»¶
            if [[ -f "/usr/lib/x86_64-linux-gnu/libomp.so" ]] || [[ -f "/usr/lib/libomp.so" ]]; then
              echo "âœ… OpenMP shared library found"
              ls -la /usr/lib/x86_64-linux-gnu/libomp.so* 2>/dev/null || ls -la /usr/lib/libomp.so* 2>/dev/null
            else
              echo "âŒ OpenMP shared library not found"
              exit 1
            fi
            
            # æ£€æŸ¥ OpenMP å¤´æ–‡ä»¶
            if [[ -f "/usr/lib/x86_64-linux-gnu/libomp.a" ]] || [[ -f "/usr/lib/libomp.a" ]]; then
              echo "âœ… OpenMP static library found"
            else
              echo "âš ï¸  OpenMP static library not found (not critical)"
            fi
            
            # æ£€æŸ¥ç¼–è¯‘å™¨ OpenMP æ”¯æŒ
            echo "Testing compiler OpenMP support..."
            cat > test_openmp.c << 'EOF'
            #include <omp.h>
            #include <stdio.h>
            int main() {
                printf("OpenMP version: %d\\n", _OPENMP);
                printf("Max threads: %d\\n", omp_get_max_threads());
                return 0;
            }
            EOF
            
            if gcc -fopenmp test_openmp.c -o test_openmp -lomp 2>/dev/null; then
              echo "âœ… GCC OpenMP compilation test passed"
              ./test_openmp || echo "âš ï¸  OpenMP runtime test failed"
            else
              echo "âŒ GCC OpenMP compilation test failed"
              exit 1
            fi
            
            rm -f test_openmp.c test_openmp
            
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "=== Installing dependencies on macOS ==="
            
            # æ£€æµ‹ç³»ç»Ÿæ¶æ„å’Œ GitHub Actions runner ç±»å‹
            SYSTEM_ARCH=$(uname -m)
            echo "System architecture: $SYSTEM_ARCH"
            echo "GitHub Runner OS: ${{ matrix.os }}"
            
            # ç¡®å®šç›®æ ‡æ¶æ„å’Œç›¸åº”çš„ Homebrew è·¯å¾„
            # GitHub Actions runners:
            # - macos-12, macos-13: é€šå¸¸æ˜¯ x86_64
            # - macos-14, macos-15: é€šå¸¸æ˜¯ ARM64 (Apple Silicon)
            if [[ "${{ matrix.os }}" == "macos-12" || "${{ matrix.os }}" == "macos-13" ]]; then
              TARGET_ARCH="x86_64"
              HOMEBREW_PREFIX="/usr/local"
              echo "Target architecture: x86_64 (Intel Mac)"
            else
              TARGET_ARCH="arm64"
              HOMEBREW_PREFIX="/opt/homebrew"
              echo "Target architecture: arm64 (Apple Silicon)"
            fi
            
            # æ£€æŸ¥å¹¶å®‰è£…é€‚å½“çš„ Homebrewï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [[ "$TARGET_ARCH" == "x86_64" ]]; then
              echo "=== Setting up x86_64 Homebrew ==="
              
              # å¦‚æœæ˜¯ Apple Silicon ç³»ç»Ÿä½†éœ€è¦ x86_64 æ„å»º
              if [[ "$SYSTEM_ARCH" == "arm64" ]]; then
                echo "Installing x86_64 Homebrew on Apple Silicon..."
                
                # æ£€æŸ¥ x86_64 Homebrew æ˜¯å¦å·²å®‰è£…
                if [[ ! -f "/usr/local/bin/brew" ]]; then
                  echo "Installing x86_64 Homebrew..."
                  arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                fi
                
                # ä½¿ç”¨ x86_64 æ¶æ„è¿è¡Œ Homebrew å‘½ä»¤
                echo "Installing dependencies with x86_64 Homebrew..."
                arch -x86_64 /usr/local/bin/brew install cmake libomp
              else
                # æœ¬èº«å°±æ˜¯ x86_64 ç³»ç»Ÿ
                echo "Using native x86_64 Homebrew..."
                brew install cmake libomp
              fi
              
              # è®¾ç½® x86_64 ç¯å¢ƒå˜é‡
              echo "HOMEBREW_PREFIX=/usr/local" >> $GITHUB_ENV
              echo "LDFLAGS=-L/usr/local/opt/libomp/lib" >> $GITHUB_ENV
              echo "CPPFLAGS=-I/usr/local/opt/libomp/include" >> $GITHUB_ENV
              echo "OpenMP_ROOT=/usr/local/opt/libomp" >> $GITHUB_ENV
              echo "CMAKE_PREFIX_PATH=/usr/local" >> $GITHUB_ENV
              
            else
              echo "=== Setting up ARM64 Homebrew ==="
              
              # Apple Silicon åŸç”Ÿå®‰è£…
              echo "Using native ARM64 Homebrew..."
              brew install cmake libomp
              
              # è®¾ç½® ARM64 ç¯å¢ƒå˜é‡
              echo "HOMEBREW_PREFIX=/opt/homebrew" >> $GITHUB_ENV
              echo "LDFLAGS=-L/opt/homebrew/opt/libomp/lib" >> $GITHUB_ENV
              echo "CPPFLAGS=-I/opt/homebrew/opt/libomp/include" >> $GITHUB_ENV
              echo "OpenMP_ROOT=/opt/homebrew/opt/libomp" >> $GITHUB_ENV
              echo "CMAKE_PREFIX_PATH=/opt/homebrew" >> $GITHUB_ENV
            fi
            
            echo ""
            echo "=== Verifying OpenMP installation on macOS ==="
            
            # æ ¹æ®ç›®æ ‡æ¶æ„ä½¿ç”¨ç›¸åº”çš„ brew å‘½ä»¤éªŒè¯
            if [[ "$TARGET_ARCH" == "x86_64" && "$SYSTEM_ARCH" == "arm64" ]]; then
              # åœ¨ Apple Silicon ä¸ŠéªŒè¯ x86_64 Homebrew å®‰è£…
              if arch -x86_64 /usr/local/bin/brew list libomp >/dev/null 2>&1; then
                echo "âœ… libomp package installed via x86_64 Homebrew"
                arch -x86_64 /usr/local/bin/brew list --versions libomp
              else
                echo "âŒ libomp package not found in x86_64 Homebrew"
                exit 1
              fi
            else
              # ä½¿ç”¨é»˜è®¤ brew å‘½ä»¤éªŒè¯
              if brew list libomp >/dev/null 2>&1; then
                echo "âœ… libomp package installed via Homebrew"
                brew list --versions libomp
              else
                echo "âŒ libomp package not found"
                exit 1
              fi
            fi
            
            # æ£€æŸ¥ç›®æ ‡æ¶æ„å¯¹åº”çš„åº“æ–‡ä»¶è·¯å¾„
            echo "Checking OpenMP library for $TARGET_ARCH architecture..."
            EXPECTED_LIB_PATH="$HOMEBREW_PREFIX/opt/libomp/lib/libomp.dylib"
            EXPECTED_HEADER_PATH="$HOMEBREW_PREFIX/opt/libomp/include/omp.h"
            
            if [[ -f "$EXPECTED_LIB_PATH" ]]; then
              echo "âœ… OpenMP library found at: $EXPECTED_LIB_PATH"
              ls -la "$EXPECTED_LIB_PATH"
              
              # æ£€æŸ¥åº“çš„æ¶æ„
              echo "Library architecture info:"
              file "$EXPECTED_LIB_PATH" || echo "Unable to check library architecture"
            else
              echo "âŒ OpenMP library not found at expected location: $EXPECTED_LIB_PATH"
              echo "Searching for libomp files in $HOMEBREW_PREFIX:"
              find "$HOMEBREW_PREFIX" -name "*libomp*" 2>/dev/null | head -10 || echo "No libomp files found"
              exit 1
            fi
            
            # æ£€æŸ¥å¤´æ–‡ä»¶
            if [[ -f "$EXPECTED_HEADER_PATH" ]]; then
              echo "âœ… OpenMP header found at: $EXPECTED_HEADER_PATH"
            else
              echo "âŒ OpenMP header file not found at: $EXPECTED_HEADER_PATH"
              exit 1
            fi
            
            # æµ‹è¯•ç¼–è¯‘å™¨ OpenMP æ”¯æŒ
            echo "Testing compiler OpenMP support for $TARGET_ARCH architecture..."
            cat > test_openmp.c << 'EOF'
            #include <omp.h>
            #include <stdio.h>
            int main() {
                printf("OpenMP version: %d\\n", _OPENMP);
                printf("Max threads: %d\\n", omp_get_max_threads());
                return 0;
            }
            EOF
            
            # è®¾ç½®ç¼–è¯‘æ ‡å¿—
            COMPILE_FLAGS="-Xpreprocessor -fopenmp -L$HOMEBREW_PREFIX/opt/libomp/lib -I$HOMEBREW_PREFIX/opt/libomp/include -lomp"
            
            # å¦‚æœéœ€è¦äº¤å‰ç¼–è¯‘åˆ° x86_64
            if [[ "$TARGET_ARCH" == "x86_64" && "$SYSTEM_ARCH" == "arm64" ]]; then
              COMPILE_FLAGS="-arch x86_64 $COMPILE_FLAGS"
              echo "Using cross-compilation flags for x86_64 on Apple Silicon"
            elif [[ "$TARGET_ARCH" == "x86_64" ]]; then
              COMPILE_FLAGS="-arch x86_64 $COMPILE_FLAGS"
              echo "Using x86_64 compilation flags"
            else
              COMPILE_FLAGS="-arch arm64 $COMPILE_FLAGS"
              echo "Using ARM64 compilation flags"
            fi
            
            echo "Compile command: clang $COMPILE_FLAGS test_openmp.c -o test_openmp"
            
            if clang $COMPILE_FLAGS test_openmp.c -o test_openmp 2>/dev/null; then
              echo "âœ… Clang OpenMP compilation test passed"
              
              # æ£€æŸ¥ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æ¶æ„
              echo "Generated binary architecture:"
              file test_openmp || echo "Unable to check binary architecture"
              
              # è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæ¶æ„åŒ¹é…ï¼‰
              if [[ "$TARGET_ARCH" == "$SYSTEM_ARCH" ]] || [[ "$TARGET_ARCH" == "x86_64" && "$SYSTEM_ARCH" == "arm64" ]]; then
                echo "Running OpenMP test..."
                ./test_openmp || echo "âš ï¸  OpenMP runtime test failed"
              else
                echo "Skipping runtime test due to architecture mismatch"
              fi
            else
              echo "âŒ Clang OpenMP compilation test failed"
              echo "Compilation error details:"
              clang $COMPILE_FLAGS test_openmp.c -o test_openmp 2>&1 || true
              
              echo "Trying simplified compilation flags..."
              SIMPLE_FLAGS="-Xpreprocessor -fopenmp -lomp"
              if clang $SIMPLE_FLAGS test_openmp.c -o test_openmp 2>/dev/null; then
                echo "âœ… Simplified OpenMP compilation succeeded"
                ./test_openmp || echo "âš ï¸  OpenMP runtime test failed"
              else
                echo "âŒ All OpenMP compilation attempts failed"
                exit 1
              fi
            fi
            
            rm -f test_openmp.c test_openmp
          fi

      - name: Configure and Build
        run: |
          mkdir build && cd build

          # è®¾ç½® CMake é…ç½®å‚æ•°
          CMAKE_ARGS="-DCMAKE_BUILD_TYPE=${{ matrix.build_type }}"

          # macOS ç‰¹å®šé…ç½®
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "Configuring for macOS build..."
            
            # æ ¹æ® GitHub Actions runner ç¡®å®šæ¶æ„
            if [[ "${{ matrix.os }}" == "macos-12" || "${{ matrix.os }}" == "macos-13" ]]; then
              echo "Configuring for x86_64 architecture..."
              CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_OSX_ARCHITECTURES=x86_64"
              CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_PREFIX_PATH=/usr/local"
            else
              echo "Configuring for ARM64 architecture..."
              CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_OSX_ARCHITECTURES=arm64"
              CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_PREFIX_PATH=/opt/homebrew"
            fi
            
            # æ˜¾ç¤ºè®¾ç½®çš„ç¯å¢ƒå˜é‡
            echo "Environment variables:"
            echo "LDFLAGS: $LDFLAGS"
            echo "CPPFLAGS: $CPPFLAGS"
            echo "OpenMP_ROOT: $OpenMP_ROOT"
          fi

          echo "CMake configuration command: cmake .. $CMAKE_ARGS"
          cmake .. $CMAKE_ARGS

          echo "Building project..."
          cmake --build .

      - name: Verify build artifacts
        run: |
          echo "=== Build Verification for ${{ matrix.name }} (${{ matrix.build_type }}) ==="

          # è®¾ç½®é¢„æœŸçš„æ„å»ºç›®å½•
          BUILD_DIR="bin/${{ matrix.build_type }}"
          echo "Checking build directory: $BUILD_DIR"

          # æ£€æŸ¥æ„å»ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ ! -d "$BUILD_DIR" ]]; then
            echo "âŒ Build directory $BUILD_DIR not found!"
            echo "Available directories in bin/:"
            ls -la bin/ 2>/dev/null || echo "bin/ directory does not exist"
            exit 1
          fi

          echo "âœ… Build directory exists: $BUILD_DIR"
          echo ""

          # æ£€æŸ¥é¢„æœŸçš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== Checking Executables ==="
          EXECUTABLES=(
            "PandoraSimulator"
            "PandoraTrader"
          )

          for exe in "${EXECUTABLES[@]}"; do
            exe_path="$BUILD_DIR/$exe"
            if [[ -f "$exe_path" ]]; then
              echo "âœ… $exe found"
              echo "   Path: $exe_path"
              echo "   Size: $(du -sh "$exe_path" | cut -f1)"
              
              # æ£€æŸ¥æ˜¯å¦å¯æ‰§è¡Œï¼ˆLinuxï¼‰
              if [[ "$RUNNER_OS" == "Linux" ]]; then
                if [[ -x "$exe_path" ]]; then
                  echo "   Permissions: âœ… Executable"
                else
                  echo "   Permissions: âŒ Not executable"
                fi
              fi
              
              # æ£€æŸ¥ä¾èµ–åº“ï¼ˆä»…ä½œä¸ºä¿¡æ¯æ˜¾ç¤ºï¼‰
              if [[ "$RUNNER_OS" == "Linux" ]] && command -v ldd >/dev/null 2>&1; then
                echo "   Dependencies (first 3):"
                ldd "$exe_path" 2>/dev/null | head -3 | sed 's/^/     /' || echo "     Unable to check dependencies"
              elif [[ "$RUNNER_OS" == "macOS" ]]; then
                # æ£€æŸ¥ macOS äºŒè¿›åˆ¶æ–‡ä»¶æ¶æ„
                echo "   Architecture:"
                file "$exe_path" | sed 's/^/     /' || echo "     Unable to check architecture"
                
                # æ£€æŸ¥ä¾èµ–åº“
                if command -v otool >/dev/null 2>&1; then
                  echo "   Dependencies (first 3):"
                  otool -L "$exe_path" 2>/dev/null | head -4 | tail -3 | sed 's/^/     /' || echo "     Unable to check dependencies"
                fi
                
                # éªŒè¯æ¶æ„æ˜¯å¦ç¬¦åˆé¢„æœŸ
                if [[ "${{ matrix.os }}" == "macos-12" || "${{ matrix.os }}" == "macos-13" ]]; then
                  if file "$exe_path" | grep -q "x86_64"; then
                    echo "   âœ… Architecture verification: x86_64 as expected"
                  else
                    echo "   âš ï¸  Architecture warning: Expected x86_64, got:"
                    file "$exe_path" | sed 's/^/       /'
                  fi
                else
                  if file "$exe_path" | grep -q "arm64"; then
                    echo "   âœ… Architecture verification: ARM64 as expected"
                  else
                    echo "   âš ï¸  Architecture warning: Expected ARM64, got:"
                    file "$exe_path" | sed 's/^/       /'
                  fi
                fi
              fi
            else
              echo "âŒ $exe NOT FOUND at $exe_path"
              MISSING_FILES=true
            fi
            echo ""
          done

          # æ£€æŸ¥é¢„æœŸçš„åº“æ–‡ä»¶
          echo "=== Checking Libraries ==="
          LIBRARIES=(
            "libPandoraStrategy.a"
          )

          for lib in "${LIBRARIES[@]}"; do
            lib_path="$BUILD_DIR/$lib"
            if [[ -f "$lib_path" ]]; then
              echo "âœ… $lib found"
              echo "   Path: $lib_path"
              echo "   Size: $(du -sh "$lib_path" | cut -f1)"
              
              # æ£€æŸ¥åº“æ–‡ä»¶å†…å®¹ï¼ˆä»…ä½œä¸ºä¿¡æ¯æ˜¾ç¤ºï¼‰
              if command -v ar >/dev/null 2>&1; then
                echo "   Objects in library:"
                ar -t "$lib_path" 2>/dev/null | head -5 | sed 's/^/     /' || echo "     Unable to list objects"
                if [[ $(ar -t "$lib_path" 2>/dev/null | wc -l) -gt 5 ]]; then
                  echo "     ... and $(( $(ar -t "$lib_path" 2>/dev/null | wc -l) - 5 )) more objects"
                fi
              fi
            else
              echo "âŒ $lib NOT FOUND at $lib_path"
              MISSING_FILES=true
            fi
            echo ""
          done

          # æ£€æŸ¥æ„å»ºç›®å½•çš„æ€»ä½“æƒ…å†µ
          echo "=== Build Directory Summary ==="
          echo "Total files in $BUILD_DIR:"
          find "$BUILD_DIR" -type f | wc -l
          echo ""
          echo "Directory size: $(du -sh "$BUILD_DIR" | cut -f1)"
          echo ""
          echo "All files in $BUILD_DIR:"
          ls -lah "$BUILD_DIR"
          echo ""

          # æœ€ç»ˆéªŒè¯ç»“æœ
          if [[ "$MISSING_FILES" == "true" ]]; then
            echo "âŒ BUILD VERIFICATION FAILED: Some expected files are missing!"
            exit 1
          else
            echo "âœ… BUILD VERIFICATION PASSED: All expected files generated successfully!"
            echo "ğŸ‰ Build completed successfully for ${{ matrix.name }} (${{ matrix.build_type }})"
          fi
