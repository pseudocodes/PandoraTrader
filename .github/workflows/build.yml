name: Build PandoraTrader

on:
  push:
    branches: [main, ndev, develop]
  pull_request:
    branches: [main, ndev, develop]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu ç‰ˆæœ¬
          - os: ubuntu-24.04
            name: 'Ubuntu 24.04'
            build_type: Debug
          - os: ubuntu-24.04
            name: 'Ubuntu 24.04'
            build_type: Release
          - os: ubuntu-22.04
            name: 'Ubuntu 22.04'
            build_type: Debug
          - os: ubuntu-22.04
            name: 'Ubuntu 22.04'
            build_type: Release
          # macOS ç‰ˆæœ¬
          - os: macos-15
            name: 'macOS 15'
            build_type: Debug
          - os: macos-15
            name: 'macOS 15'
            build_type: Release
          - os: macos-14
            name: 'macOS 14'
            build_type: Debug
          - os: macos-14
            name: 'macOS 14'
            build_type: Release

    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.name }} (${{ matrix.build_type }})

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y cmake build-essential libomp-dev
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install cmake libomp
          fi

      - name: Configure and Build
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build . --parallel 2

      - name: Verify build artifacts
        run: |
          echo "=== Build Verification for ${{ matrix.name }} (${{ matrix.build_type }}) ==="

          # è®¾ç½®é¢„æœŸçš„æ„å»ºç›®å½•
          BUILD_DIR="bin/${{ matrix.build_type }}"
          echo "Checking build directory: $BUILD_DIR"

          # æ£€æŸ¥æ„å»ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ ! -d "$BUILD_DIR" ]]; then
            echo "âŒ Build directory $BUILD_DIR not found!"
            echo "Available directories in bin/:"
            ls -la bin/ 2>/dev/null || echo "bin/ directory does not exist"
            exit 1
          fi

          echo "âœ… Build directory exists: $BUILD_DIR"
          echo ""

          # æ£€æŸ¥é¢„æœŸçš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== Checking Executables ==="
          EXECUTABLES=(
            "PandoraSimulator"
            "PandoraTrader"
          )

          for exe in "${EXECUTABLES[@]}"; do
            exe_path="$BUILD_DIR/$exe"
            if [[ -f "$exe_path" ]]; then
              echo "âœ… $exe found"
              echo "   Path: $exe_path"
              echo "   Size: $(du -sh "$exe_path" | cut -f1)"
              
              # æ£€æŸ¥æ˜¯å¦å¯æ‰§è¡Œï¼ˆLinuxï¼‰
              if [[ "$RUNNER_OS" == "Linux" ]]; then
                if [[ -x "$exe_path" ]]; then
                  echo "   Permissions: âœ… Executable"
                else
                  echo "   Permissions: âŒ Not executable"
                fi
              fi
              
              # æ£€æŸ¥ä¾èµ–åº“ï¼ˆä»…ä½œä¸ºä¿¡æ¯æ˜¾ç¤ºï¼‰
              if [[ "$RUNNER_OS" == "Linux" ]] && command -v ldd >/dev/null 2>&1; then
                echo "   Dependencies (first 3):"
                ldd "$exe_path" 2>/dev/null | head -3 | sed 's/^/     /' || echo "     Unable to check dependencies"
              elif [[ "$RUNNER_OS" == "macOS" ]] && command -v otool >/dev/null 2>&1; then
                echo "   Dependencies (first 3):"
                otool -L "$exe_path" 2>/dev/null | head -4 | tail -3 | sed 's/^/     /' || echo "     Unable to check dependencies"
              fi
            else
              echo "âŒ $exe NOT FOUND at $exe_path"
              MISSING_FILES=true
            fi
            echo ""
          done

          # æ£€æŸ¥é¢„æœŸçš„åº“æ–‡ä»¶
          echo "=== Checking Libraries ==="
          LIBRARIES=(
            "libPandoraStrategy.a"
          )

          for lib in "${LIBRARIES[@]}"; do
            lib_path="$BUILD_DIR/$lib"
            if [[ -f "$lib_path" ]]; then
              echo "âœ… $lib found"
              echo "   Path: $lib_path"
              echo "   Size: $(du -sh "$lib_path" | cut -f1)"
              
              # æ£€æŸ¥åº“æ–‡ä»¶å†…å®¹ï¼ˆä»…ä½œä¸ºä¿¡æ¯æ˜¾ç¤ºï¼‰
              if command -v ar >/dev/null 2>&1; then
                echo "   Objects in library:"
                ar -t "$lib_path" 2>/dev/null | head -5 | sed 's/^/     /' || echo "     Unable to list objects"
                if [[ $(ar -t "$lib_path" 2>/dev/null | wc -l) -gt 5 ]]; then
                  echo "     ... and $(( $(ar -t "$lib_path" 2>/dev/null | wc -l) - 5 )) more objects"
                fi
              fi
            else
              echo "âŒ $lib NOT FOUND at $lib_path"
              MISSING_FILES=true
            fi
            echo ""
          done

          # æ£€æŸ¥æ„å»ºç›®å½•çš„æ€»ä½“æƒ…å†µ
          echo "=== Build Directory Summary ==="
          echo "Total files in $BUILD_DIR:"
          find "$BUILD_DIR" -type f | wc -l
          echo ""
          echo "Directory size: $(du -sh "$BUILD_DIR" | cut -f1)"
          echo ""
          echo "All files in $BUILD_DIR:"
          ls -lah "$BUILD_DIR"
          echo ""

          # æœ€ç»ˆéªŒè¯ç»“æœ
          if [[ "$MISSING_FILES" == "true" ]]; then
            echo "âŒ BUILD VERIFICATION FAILED: Some expected files are missing!"
            exit 1
          else
            echo "âœ… BUILD VERIFICATION PASSED: All expected files generated successfully!"
            echo "ğŸ‰ Build completed successfully for ${{ matrix.name }} (${{ matrix.build_type }})"
          fi
